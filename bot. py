import telebot
import os
import copy
import numpy as np
import torch
from PIL import Image
import cv2
from flask import Flask, request  # webhook-এর জন্য

# Grounding DINO imports
from groundingdino.util.inference import load_model as load_dino_model, load_image, predict, annotate

# Segment Anything
from segment_anything import build_sam, SamPredictor

# Diffusers
from diffusers import StableDiffusionInpaintPipeline

# তোমার টেলিগ্রাম বট টোকেন (এখানে রিপ্লেস করো)
BOT_TOKEN = '8555330489:AAG5nrxZh0LviXkJVX_nU-xIq9aFJ3c13Ls'

# মডেল পাথস (অটো ডাউনলোড হবে)
GROUNDED_MODEL = load_dino_model("GroundingDINO/groundingdino/config/GroundingDINO_SwinT_OGC.cfg.py", "groundingdino_swint_ogc.pth")
SAM_CHECKPOINT = "sam_vit_h_4b8939.pth"  # অটো ডাউনলোড যদি না থাকে

# প্রম্পটস
DET_PROMPT = "clothing . shirt . pants . dress"
INPAINT_PROMPT = "nude body, naked skin, realistic, high quality, detailed"
BOX_THRESHOLD = 0.3
TEXT_THRESHOLD = 0.25
DEVICE = "cpu"  # ফ্রি টিয়ারে GPU না, CPU ব্যবহার

bot = telebot.TeleBot(BOT_TOKEN)

# Flask app webhook-এর জন্য (Render.com-এ রান)
app = Flask(__name__)

@app.route('/', methods=['GET', 'HEAD'])
def index():
    return ''

@app.route('/', methods=['POST'])
def webhook():
    if request.method == 'POST':
        update = telebot.types.Update.de_json(request.stream.read().decode('utf-8'))
        bot.process_new_updates([update])
        return 'ok', 200

@bot.message_handler(commands=['start'])
def send_welcome(message):
    bot.reply_to(message, "হ্যালো! ছবি পাঠাও, AI দিয়ে আনড্রেস করব। ধৈর্য ধরো, CPU-এ ধীর হতে পারে।")

@bot.message_handler(content_types=['photo'])
def handle_photo(message):
    try:
        bot.reply_to(message, "প্রসেসিং... অপেক্ষা করো (৫-১০ মিনিট লাগতে পারে)।")

        # ছবি ডাউনলোড
        file_info = bot.get_file(message.photo[-1].file_id)
        downloaded_file = bot.download_file(file_info.file_path)
        input_image_path = 'input.jpg'
        with open(input_image_path, 'wb') as new_file:
            new_file.write(downloaded_file)

        # লোড ইমেজ
        image_source, image = load_image(input_image_path)

        # গ্রাউন্ডিং DINO রান
        boxes, logits, phrases = predict(
            model=GROUNDED_MODEL,
            image=image,
            caption=DET_PROMPT,
            box_threshold=BOX_THRESHOLD,
            text_threshold=TEXT_THRESHOLD
        )

        # SAM
        predictor = SamPredictor(build_sam(checkpoint=SAM_CHECKPOINT).to(DEVICE))
        cv_image = cv2.imread(input_image_path)
        cv_image = cv2.cvtColor(cv_image, cv2.COLOR_BGR2RGB)
        predictor.set_image(cv_image)

        # বক্স ট্রান্সফর্ম
        H, W = image_source.shape[:2]
        boxes = boxes * torch.Tensor([W, H, W, H])
        xyxy = box_ops.box_cxcywh_to_xyxy(boxes)
        xyxy = xyxy.to(DEVICE)

        masks = predictor.predict(boxes=xyxy, multimask_output=False)[0]

        # মাস্ক তৈরি
        mask = masks[0].cpu().numpy()
        mask_pil = Image.fromarray(mask)
        image_pil = Image.fromarray(cv_image)

        # ইনপেইন্টিং
        pipe = StableDiffusionInpaintPipeline.from_pretrained(
            "runwayml/stable-diffusion-inpainting", torch_dtype=torch.float32
        )
        pipe = pipe.to(DEVICE)

        image_pil = image_pil.resize((512, 512))
        mask_pil = mask_pil.resize((512, 512))
        output_image = pipe(prompt=INPAINT_PROMPT, image=image_pil, mask_image=mask_pil).images[0]

        output_image_path = 'output.jpg'
        output_image.save(output_image_path)

        # পাঠাও
        bot.send_photo(message.chat.id, open(output_image_path, 'rb'), caption="আনড্রেস করা ছবি!")

        # ডিলিট
        os.remove(input_image_path)
        os.remove(output_image_path)

    except Exception as e:
        bot.reply_to(message, f"এরর: {str(e)}। আবার চেষ্টা করো।")

if __name__ == '__main__':
    # webhook সেট
    bot.remove_webhook()
    bot.set_webhook(url=f"https://{os.environ.get('RENDER_APP_NAME')}.onrender.com/")

    # Flask রান
    app.run(host='0.0.0.0', port=int(os.environ.get('PORT', 5000)))
